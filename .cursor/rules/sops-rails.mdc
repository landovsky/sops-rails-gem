---
description: Development guidelines for the sops_rails Ruby gem
globs: ["**/*.rb", "**/*.rake", "**/*.gemspec"]
alwaysApply: true
---

# sops_rails Development Rules

## Code Documentation Requirements

Every Ruby class and module MUST have a documentation block:

```ruby
# frozen_string_literal: true

module SopsRails
  # Brief description of what this class does.
  #
  # Longer explanation if needed, covering the "why" and key behaviors.
  # Include usage examples for public APIs.
  #
  # @example Basic usage
  #   MyClass.new.perform
  #
  class MyClass
  end
end
```

## Implementation Workflow

1. **Reference the roadmap** before implementing: `docs/implementation/00-DEVELOPMENT-ROAD-MAP.md`
2. **Check acceptance criteria** — Each feature has specific requirements to satisfy
3. **Write tests first** — TDD approach ensures verifiable implementations
4. **Document architectural decisions** in `docs/implementation/01-ARCHITECTURAL-DECISIONS.md`

## Code Patterns

### Configuration Pattern
Use a singleton configuration object accessible via `SopsRails.configure`:

```ruby
SopsRails.configure do |config|
  config.encrypted_path = "config"
end
```

### Error Handling
Define specific exceptions in `lib/sops_rails/errors.rb`:

```ruby
module SopsRails
  class Error < StandardError; end
  class SopsNotFoundError < Error; end
  class DecryptionError < Error; end
end
```

### Shell Command Execution
Use `Open3` for subprocess calls to capture stdout, stderr, and exit status:

```ruby
require "open3"

stdout, stderr, status = Open3.capture3("sops", "-d", file_path)
raise DecryptionError, stderr unless status.success?
```

### Thread-Safe Singleton Pattern
When implementing singleton-style module methods, use Mutex for thread-safe initialization:

```ruby
module SopsRails
  @mutex = Mutex.new

  def self.config
    @mutex.synchronize do
      @config ||= Configuration.new
    end
  end
end
```

### Test Helpers
Provide public reset methods instead of relying on `instance_variable_set`:

```ruby
# Good: Public API for testing
def self.reset!
  @mutex.synchronize { @config = nil }
end

# Bad: Exposing internals in tests
SopsRails.instance_variable_set(:@config, nil)
```

## Testing Requirements

- Write RSpec tests in `spec/` directory
- Use `describe` for classes/modules, `context` for conditions, `it` for behaviors
- Integration tests that need SOPS binary should be tagged: `integration: true`
- Mock external dependencies in unit tests

## File Headers

All Ruby files must start with:

```ruby
# frozen_string_literal: true
```

## Naming Conventions

- Classes: `PascalCase` (e.g., `CredentialsReader`)
- Methods/variables: `snake_case` (e.g., `decrypt_file`)
- Constants: `SCREAMING_SNAKE_CASE` (e.g., `MINIMUM_VERSION`)
- Files: `snake_case.rb` matching the class name

## Security Rules

- NEVER write decrypted content to filesystem
- NEVER log or output secret values
- ALWAYS validate age public key format before use
- ALWAYS use `Open3` over backticks for shell commands (captures stderr)

## Ruby Style Preferences

### Guard Clauses
Prefer single-line guard clauses over multi-line conditional blocks:

```ruby
# Good: Guard clause
raise SopsNotFoundError, "message" unless status.success?
return nil unless valid?

# Avoid: Multi-line block for simple conditions
unless status.success?
  raise SopsNotFoundError, "message"
end
```

### Line Length
Keep lines under 120 characters. For long method chains, break at logical argument boundaries:

```ruby
# Good: Break at argument boundaries
allow(Open3).to receive(:capture3).with("sops",
                                        "--version").and_return(["3.8.1", "", status])

# Avoid: Single line over 120 chars
```

## RSpec Guidelines

### Block Length
RSpec `describe`/`context` blocks are naturally large. The `.rubocop.yml` excludes spec files from `Metrics/BlockLength` checks.

### Expectation Blocks
For expectations that raise errors, prefer `do...end` for multi-line or `{ }` for single-line:

```ruby
# Good: do...end for multi-line
expect do
  described_class.decrypt(file_path)
end.to raise_error(SopsRails::DecryptionError)

# Good: braces for single line (if under 120 chars)
expect { described_class.version }.to raise_error(SopsRails::SopsNotFoundError)
```

### Mocking Open3
When mocking `Open3.capture3`, break long argument lists across lines:

```ruby
allow(Open3).to receive(:capture3).with("sops", "-d",
                                        file_path).and_return([content, "", status])
```

## Commit Guidelines

- Small, focused commits addressing one logical change
- Reference stage/feature from roadmap when applicable
- Format: `[Stage X.Y] Brief description of change`
